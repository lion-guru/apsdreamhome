# =============================================
# APS Dream Home - URL Rewriting and Security
# =============================================

# Enable the rewrite engine
RewriteEngine On

# Set the base directory
RewriteBase /apsdreamhomefinal/

# Handle Front Controller (only if file doesn't exist)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ router.php?url=$1 [QSA,L]

# Alternative rule for direct admin access
RewriteRule ^admin$ router.php?url=admin [QSA,L]
RewriteRule ^admin/(.*)$ router.php?url=admin/$1 [QSA,L]

# Block access to sensitive files
<FilesMatch "^\.|\.(ini|log|sh|sql|tpl|twig|json|lock|md|gitignore|gitattributes|env|example|dist|config|yml|yaml)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Allow access to specific file types
<FilesMatch "\.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|map)$">
    Order allow,deny
    Allow from all
</FilesMatch>

# Security Headers
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
</IfModule>

# Allow access to specific file types
<FilesMatch "\.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|map)$">
    Order allow,deny
    Allow from all
</FilesMatch>

# Block access to specific directories
<IfModule mod_rewrite.c>
    RewriteRule ^(vendor|node_modules|\.git|storage/logs|storage/framework) - [F,L,NC]
</IfModule>

# Security Headers
<IfModule mod_headers.c>
    # Security Headers
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
    Header set X-Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data:;"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Remove server signature
    Header unset X-Powered-By
    Header always unset X-Powered-By
    ServerSignature Off
</IfModule>

# PHP Settings
<IfModule mod_php7.c>
    php_flag display_errors Off
    php_value error_reporting E_ALL & ~E_NOTICE & ~E_DEPRECATED
    php_value max_execution_time 300
    php_value memory_limit 256M
    php_value post_max_size 64M
    php_value upload_max_filesize 64M
    php_flag session.cookie_httponly on
    php_flag session.cookie_secure on
    php_flag session.use_only_cookies on
</IfModule>

# MIME Type Security
<IfModule mod_mime.c>
    AddType application/javascript          js
    AddType application/vnd.ms-fontobject   eot
    AddType application/x-font-ttf          ttf ttc
    AddType font/opentype                   otf
    AddType application/x-font-woff         woff
    AddType image/svg+xml                   svg svgz 
    AddEncoding gzip                        svgz
</IfModule>

# GZIP Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE font/opentype font/ttf font/eot font/otf
    
    # Remove browser bugs
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
</IfModule>

# Cache Control
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Default expiration: 2 days
    ExpiresDefault "access plus 2 days"
    
    # HTML: No cache
    ExpiresByType text/html "access plus 0 seconds"
    
    # CSS, JavaScript, Text
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType text/javascript "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    
    # Media files
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # Web fonts
    ExpiresByType application/x-font-ttf "access plus 1 year"
    ExpiresByType font/opentype "access plus 1 year"
    ExpiresByType application/x-font-woff "access plus 1 year"
    ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
    
    # Other
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType application/x-shockwave-flash "access plus 1 month"
    
    # Cache control header
    <IfModule mod_headers.c>
        Header append Cache-Control "public"
    </IfModule>
</IfModule>

# Block access to sensitive files
<FilesMatch "^\.|composer\.json|composer\.lock|package\.json|package-lock\.json|webpack\.config\.js|yarn\.lock$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Block access to hidden files and directories
<IfModule mod_rewrite.c>
    RewriteCond %{SCRIPT_FILENAME} -d [OR]
    RewriteCond %{SCRIPT_FILENAME} -f
    RewriteRule "(^|/)\." - [F]
</IfModule>

# Prevent directory listing
<IfModule mod_autoindex.c>
    Options -Indexes
</IfModule>

# Protect against hotlinking
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https?://(?:www\.)?yourdomain\.com [NC]
    RewriteRule \.(jpe?g|gif|bmp|png|webp)$ - [NC,F,L]
</IfModule>

# Custom Error Pages
ErrorDocument 400 /error.php?code=400
ErrorDocument 401 /error.php?code=401
ErrorDocument 403 /error.php?code=403
ErrorDocument 404 /error.php?code=404
ErrorDocument 500 /error.php?code=500

# Enable Keep-Alive
<IfModule mod_headers.c>
    Header set Connection keep-alive
</IfModule>

# Disable server signature
ServerSignature Off
