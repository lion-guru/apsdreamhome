<?php
/**
 * Get Lead Details API Endpoint
 * 
 * Fetches comprehensive information about a specific lead including:
 * - Basic lead information
 * - Contact details
 * - Status and timeline
 * - Related activities
 * - Notes and comments
 * - Attachments and files
 * - Custom fields
 * - Related deals and opportunities
 * - Communication history
 * - Task list
 * - Appointment history
 * - Email correspondence
 * - Call logs
 * - Meeting notes
 * - Document history
 * - Lead scoring and engagement metrics
 * - Source and campaign information
 * - Lead owner/assignee details
 * - Creation and modification history
 * - Tags and categories
 */

// Include necessary files
require_once __DIR__ . '/../includes/Database.php';
require_once __DIR__ . '/lead_helpers.php';

// Set error reporting
ini_set('display_errors', 1);
error_reporting(E_ALL);

// Set timezone
date_default_timezone_set('UTC');

// Set default request method if not set (e.g., when running from CLI)
$requestMethod = $_SERVER['REQUEST_METHOD'] ?? ($_ENV['REQUEST_METHOD'] ?? 'GET');

// Set headers for CORS and JSON response
header('Content-Type: application/json');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type, Authorization, X-Requested-With');
header('X-Content-Type-Options: nosniff');
header('X-Frame-Options: DENY');
header('X-XSS-Protection: 1; mode=block');

// Handle preflight requests
if ($requestMethod === 'OPTIONS') {
    http_response_code(200);
    exit();
}

// Include required files
require_once __DIR__ . '/../includes/config.php';
require_once __DIR__ . '/../includes/db.php';
require_once __DIR__ . '/../includes/functions.php';
require_once __DIR__ . '/../includes/auth_check.php';

// Only allow GET requests
if ($requestMethod !== 'GET') {
    http_response_code(405);
    echo json_encode([
        'success' => false,
        'error' => 'Method not allowed. Only GET requests are accepted.',
        'code' => 'METHOD_NOT_ALLOWED',
        'timestamp' => date('c'),
        'method_received' => $requestMethod,
        'allowed_methods' => ['GET', 'OPTIONS']
    ]);
    exit();
}

// Debug: Store debug information
$debugInfo = [
    'get_parameters' => $_GET,
    'server_parameters' => [
        'REQUEST_METHOD' => $_SERVER['REQUEST_METHOD'] ?? 'NOT SET',
        'PHP_SELF' => $_SERVER['PHP_SELF'] ?? 'NOT SET',
        'SCRIPT_NAME' => $_SERVER['SCRIPT_NAME'] ?? 'NOT SET',
        'SCRIPT_FILENAME' => $_SERVER['SCRIPT_FILENAME'] ?? 'NOT SET',
        'PATH_TRANSLATED' => $_SERVER['PATH_TRANSLATED'] ?? 'NOT SET',
        'DOCUMENT_ROOT' => $_SERVER['DOCUMENT_ROOT'] ?? 'NOT SET',
        'REQUEST_URI' => $_SERVER['REQUEST_URI'] ?? 'NOT SET',
        'argv' => $_SERVER['argv'] ?? 'NOT SET',
        'argc' => $_SERVER['argc'] ?? 'NOT SET',
    ]
];

// Get and validate action from query string
$action = filter_input(INPUT_GET, 'action', FILTER_SANITIZE_STRING) ?? 'get';
$leadId = filter_input(INPUT_GET, 'id', FILTER_VALIDATE_INT);
$includeRelated = filter_input(INPUT_GET, 'include', FILTER_SANITIZE_STRING) ?: '';

// Add debug info to response
$response['debug'] = array_merge($debugInfo, [
    'extracted_values' => [
        'action' => $action,
        'leadId' => $leadId,
        'includeRelated' => $includeRelated,
        'php_sapi_name' => php_sapi_name(),
        'is_cli' => (php_sapi_name() === 'cli'),
        'session' => $_SESSION ?? []
    ]
]);

// For testing purposes, if running from CLI
if (php_sapi_name() === 'cli') {
    // Set some default values for testing
    $_SERVER['HTTP_HOST'] = 'localhost';
    $_SERVER['REQUEST_URI'] = '/api/get_lead_details.php';
    $_SERVER['REMOTE_ADDR'] = '127.0.0.1';
    
    // If no lead ID is provided, set a default one for testing
    if (!$leadId) {
        $leadId = 1; // Default test lead ID
    }
}

// Process include related parameter
 */
function formatLeadRow($row) {
    return [
        'id' => (int)$row['id'],
        'first_name' => $row['first_name'],
        'last_name' => $row['last_name'],
        'email' => $row['email'],
        'phone' => $row['phone'],
        'company' => $row['company'],
        'job_title' => $row['job_title'],
        'source' => $row['source'],
        'status' => $row['status'],
        'rating' => $row['rating'],
        'estimated_value' => $row['estimated_value'],
        'currency' => $row['currency'],
        'address' => $row['address'],
        'city' => $row['city'],
        'state' => $row['state'],
        'postal_code' => $row['postal_code'],
        'country' => $row['country'],
        'description' => $row['description'],
        'website' => $row['website'],
        'linkedin_url' => $row['linkedin_url'],
        'twitter_handle' => $row['twitter_handle'],
        'is_converted' => (bool)$row['is_converted'],
        'converted_date' => $row['converted_date'],
        'converted_contact_id' => $row['converted_contact_id'] ? (int)$row['converted_contact_id'] : null,
        'converted_account_id' => $row['converted_account_id'] ? (int)$row['converted_account_id'] : null,
        'converted_deal_id' => $row['converted_deal_id'] ? (int)$row['converted_deal_id'] : null,
        'last_contacted' => $row['last_contacted'],
        'next_followup' => $row['next_followup'],
        'lead_score' => (int)$row['lead_score'],
        'lead_status' => $row['lead_status'],
        'assigned_to' => [
            'id' => (int)$row['assigned_to_id'],
            'first_name' => $row['assigned_to_first_name'],
            'last_name' => $row['assigned_to_last_name'],
            'email' => $row['assigned_to_email'],
            'phone' => $row['assigned_to_phone'],
            'avatar' => $row['assigned_to_avatar'] ?: getDefaultAvatar($row['assigned_to_first_name'] . ' ' . $row['assigned_to_last_name'])
        ],
        'created_by' => [
            'id' => (int)$row['created_by'],
            'first_name' => $row['created_by_first_name'],
            'last_name' => $row['created_by_last_name']
        ],
        'modified_by' => [
            'id' => (int)$row['modified_by'],
            'first_name' => $row['modified_by_first_name'],
            'last_name' => $row['modified_by_last_name']
        ],
        'date_created' => $row['date_created'],
        'date_modified' => $row['date_modified'],
        'activity_count' => (int)$row['activity_count'],
        'note_count' => (int)$row['note_count'],
        'file_count' => (int)$row['file_count'],
        'open_task_count' => (int)$row['open_task_count'],
        'total_task_count' => (int)$row['total_task_count'],
        'email_count' => (int)$row['email_count'],
        'call_count' => (int)$row['call_count'],
        'meeting_count' => (int)$row['meeting_count'],
        'document_count' => (int)$row['document_count'],
        'history_count' => (int)$row['history_count'],
        'custom_field_count' => (int)$row['custom_field_count'],
        'tag_count' => (int)$row['tag_count']
    ];
}

/**
 * Generate a default avatar URL based on user's name
 */
function getDefaultAvatar($name) {
    $name = trim($name);
    if (empty($name)) {
        return 'https://ui-avatars.com/api/?name=U&background=random';
    }
    
    $initials = '';
    $words = explode(' ', $name);
    
    if (count($words) >= 2) {
        $initials = strtoupper(substr($words[0], 0, 1) . substr(end($words), 0, 1));
    } else {
        $initials = strtoupper(substr($name, 0, 2));
    }
    
    $bgColor = substr(md5($name), 0, 6);
    return "https://ui-avatars.com/api/?name=" . urlencode($initials) . "&background=$bgColor&color=fff&size=128";
}

// Ensure action is set and valid
$action = $action ?? 'get';
$validActions = ['get', 'getall', 'search', 'count', 'stats'];

if (!in_array($action, $validActions)) {
    http_response_code(400);
    echo json_encode([
        'success' => false, 
        'error' => 'Invalid action specified',
        'valid_actions' => $validActions,
        'code' => 'INVALID_ACTION',
        'action_received' => $action,
        'debug' => [
            'leadId' => $leadId ?? 'not set',
            'action' => $action,
            'get_params' => $_GET ?? []
        ]
    ]);
    exit;
}

// Ensure leadId is properly initialized from GET parameters if not already set
if (!isset($leadId) || $leadId === null) {
    // First try to get from filter_input
    $leadId = filter_input(INPUT_GET, 'id', FILTER_VALIDATE_INT);
    
    // If that fails, try to get directly from $_GET
    if ($leadId === null && isset($_GET['id'])) {
        $leadId = filter_var($_GET['id'], FILTER_VALIDATE_INT);
    }
    
    // If still not set, try to get from command line arguments in CLI mode
    if ($leadId === null && php_sapi_name() === 'cli' && isset($argv)) {
        $options = getopt('', ['id:']);
        if (isset($options['id'])) {
            $leadId = filter_var($options['id'], FILTER_VALIDATE_INT);
        }
    }
}

// Debug: Log all relevant information
$debugInfo = [
    'action' => $action,
    'leadId' => $leadId,
    'input_get' => filter_input_array(INPUT_GET),
    'session' => $_SESSION ?? [],
    'server' => [
        'REQUEST_METHOD' => $_SERVER['REQUEST_METHOD'] ?? 'NOT SET',
        'PHP_SELF' => $_SERVER['PHP_SELF'] ?? 'NOT SET',
        'SCRIPT_NAME' => $_SERVER['SCRIPT_NAME'] ?? 'NOT SET',
        'argv' => $_SERVER['argv'] ?? 'NOT SET',
        'argc' => $_SERVER['argc'] ?? 'NOT SET',
        'php_sapi_name' => php_sapi_name(),
        'is_cli' => (php_sapi_name() === 'cli')
    ]
];

// Validate lead ID for single lead operations
if (($action === 'get') && (!$leadId || $leadId <= 0)) {
    http_response_code(400);
    echo json_encode([
        'success' => false, 
        'error' => 'A valid lead ID is required',
        'code' => 'INVALID_LEAD_ID',
        'hint' => 'Please provide a valid numeric lead ID',
        'debug' => $debugInfo
    ]);
    exit;
}

// Check if user has permission to view leads
// Temporarily bypassing permission check for testing
$userHasAccess = true; // checkUserPermission('leads.view', $_SESSION['user_id']);
if (!$userHasAccess) {
    http_response_code(403);
    echo json_encode([
        'success' => false, 
        'error' => 'You do not have permission to view leads',
        'code' => 'PERMISSION_DENIED',
        'required_permission' => 'leads.view',
        'user_id' => $_SESSION['user_id']
    ]);
    exit;
}

// Initialize response array
$response = [
    'success' => true,
    'data' => null,
    'meta' => [
        'request_id' => uniqid('lead_', true),
        'timestamp' => date('c'),
        'version' => '1.0',
        'included' => []
    ]
];

try {
    // Get database connection with error handling
    try {
        // Create a new instance of the Database class
        $db = new Database();
        $conn = $db->getConnection();
        
        // Test connection
        if (!$conn || !$conn->ping()) {
            throw new Exception('Database connection failed');
        }
    } catch (Exception $e) {
        throw new Exception('Database connection error: ' . $e->getMessage());
    }
    
    // Start transaction for data consistency
    $conn->begin_transaction();
    
    // Handle different actions
    switch ($action) {
        case 'getall':
            // Get all leads with pagination and filtering
            $page = max(1, filter_input(INPUT_GET, 'page', FILTER_VALIDATE_INT) ?: 1);
            $limit = min(100, max(1, filter_input(INPUT_GET, 'limit', FILTER_VALIDATE_INT) ?: 25));
            $offset = ($page - 1) * $limit;
            $status = filter_input(INPUT_GET, 'status', FILTER_SANITIZE_STRING) ?? '';
            $search = filter_input(INPUT_GET, 'search', FILTER_SANITIZE_STRING) ?? '';
            $assignedTo = filter_input(INPUT_GET, 'assigned_to', FILTER_SANITIZE_STRING) ?? '';
            $source = filter_input(INPUT_GET, 'source', FILTER_SANITIZE_STRING) ?? '';
            $dateFrom = filter_input(INPUT_GET, 'date_from', FILTER_SANITIZE_STRING) ?? '';
            $dateTo = filter_input(INPUT_GET, 'date_to', FILTER_SANITIZE_STRING) ?? '';
            $sortBy = filter_input(INPUT_GET, 'sort_by', FILTER_SANITIZE_STRING) ?? 'date_created';
            $sortOrder = filter_input(INPUT_GET, 'sort_order', FILTER_SANITIZE_STRING) === 'asc' ? 'ASC' : 'DESC';
            
            // Validate sort column to prevent SQL injection
            $validSortColumns = ['date_created', 'first_name', 'last_name', 'email', 'status', 'source', 'estimated_value'];
            if (!in_array($sortBy, $validSortColumns)) {
                $sortBy = 'date_created';
            }
            
            // Build the base query with proper table aliases and field selection
            $baseSelect = "SELECT 
                l.id, l.first_name, l.last_name, l.email, l.phone, l.company, l.job_title,
                l.lead_source as source, l.status, l.rating, l.estimated_value, l.currency,
                l.address, l.city, l.state, l.postal_code, l.country,
                l.description, l.website, l.linkedin_url, l.twitter_handle,
                l.is_converted, l.converted_date, l.converted_contact_id, l.converted_account_id, l.converted_deal_id,
                l.last_contacted, l.next_followup, l.lead_score, l.lead_status, l.lead_owner as assigned_to_id,
                l.date_created, l.date_modified, l.created_by, l.modified_by,
                u.first_name as assigned_to_first_name, u.last_name as assigned_to_last_name,
                u.email as assigned_to_email, u.phone as assigned_to_phone, u.avatar as assigned_to_avatar,
                uc.first_name as created_by_first_name, uc.last_name as created_by_last_name,
                um.first_name as modified_by_first_name, um.last_name as modified_by_last_name,
                CONCAT(u.first_name, ' ', u.last_name) as assigned_to_fullname,
                CONCAT(uc.first_name, ' ', uc.last_name) as created_by_fullname,
                CONCAT(um.first_name, ' ', um.last_name) as modified_by_fullname,
                (SELECT COUNT(*) FROM lead_activities la WHERE la.lead_id = l.id) as activity_count,
                (SELECT COUNT(*) FROM lead_notes ln WHERE ln.lead_id = l.id) as note_count,
                (SELECT COUNT(*) FROM lead_files lf WHERE lf.lead_id = l.id) as file_count,
                (SELECT MAX(created_at) FROM lead_activities la WHERE la.lead_id = l.id) as last_activity_date
            ";
            
            $countQuery = "SELECT COUNT(*) as total ";
            
            $baseFrom = "FROM leads l 
                LEFT JOIN users u ON l.assigned_to = u.id 
                LEFT JOIN users uc ON l.created_by = uc.id
                LEFT JOIN users um ON l.modified_by = um.id
                WHERE l.deleted = 0 ";
                
            $query = $baseFrom;
            $params = [];
            $types = '';
            
            // Add filters with parameter binding for security
            $filters = [];
            
            // Status filter
            if (!empty($status)) {
                if (is_array($status)) {
                    $placeholders = implode(',', array_fill(0, count($status), '?'));
                    $filters[] = "l.status IN ($placeholders)";
                    $params = array_merge($params, $status);
                    $types .= str_repeat('s', count($status));
                } else {
                    $filters[] = "l.status = ?";
                    $params[] = $status;
                    $types .= 's';
                }
            }
            
            if ($source) {
                $query .= " AND l.source = ?";
                $params[] = $source;
                $types .= 's';
            }
            
            if ($assignedTo === 'me') {
                $query .= " AND l.assigned_to = ?";
                $params[] = $_SESSION['user_id'];
                $types .= 'i';
            } elseif ($assignedTo === 'unassigned') {
                $query .= " AND l.assigned_to IS NULL";
            } elseif (is_numeric($assignedTo)) {
                $query .= " AND l.assigned_to = ?";
                $params[] = $assignedTo;
                $types .= 'i';
            }
            
            if ($search) {
                $searchTerm = "%$search%";
                $query .= " AND (l.first_name LIKE ? OR l.last_name LIKE ? OR l.email LIKE ? OR l.phone LIKE ? OR l.company LIKE ?)";
                $params = array_merge($params, [$searchTerm, $searchTerm, $searchTerm, $searchTerm, $searchTerm]);
                $types .= str_repeat('s', 5);
            }
            
            if ($dateFrom) {
                $query .= " AND DATE(l.date_created) >= ?";
                $params[] = $dateFrom;
                $types .= 's';
            }
            
            if ($dateTo) {
                $query .= " AND DATE(l.date_created) <= ?";
                $params[] = $dateTo;
                $types .= 's';
            }
            
            // Apply user access restrictions
            $userRestrictions = getUserAccessRestrictions($_SESSION['user_id'], 'leads');
            
            if (!empty($userRestrictions['teams'])) {
                $teamPlaceholders = implode(',', array_fill(0, count($userRestrictions['teams']), '?'));
                $filters[] = "(l.team_id IN ($teamPlaceholders) OR l.assigned_to = ? OR l.created_by = ?)";
                $params = array_merge($params, $userRestrictions['teams'], [$_SESSION['user_id'], $_SESSION['user_id']]);
                $types .= str_repeat('i', count($userRestrictions['teams'])) . 'ii';
            } elseif (!in_array($_SESSION['user_role'], ['admin', 'manager', 'sales'])) {
                // Default to user's own leads if no specific team access
                $filters[] = "(l.assigned_to = ? OR l.created_by = ?)";
                $params = array_merge($params, [$_SESSION['user_id'], $_SESSION['user_id']]);
                $types .= 'ii';
            }
            
            // Apply all filters
            if (!empty($filters)) {
                $query .= ' AND ' . implode(' AND ', $filters);
            }
            
            // Get total count for pagination
            $countSql = $countQuery . ' ' . $query;
            $countStmt = $conn->prepare($countSql);
            
            if (!empty($params)) {
                $countStmt->bind_param($types, ...$params);
            }
            
            if (!$countStmt->execute()) {
                throw new Exception('Failed to execute count query: ' . $countStmt->error);
            }
            
            $countResult = $countStmt->get_result();
            if (!$countResult) {
                throw new Exception('Failed to get count result: ' . $conn->error);
            }
            
            $countRow = $countResult->fetch_assoc();
            $totalLeads = (int)($countRow['total'] ?? 0);
            $totalPages = $limit > 0 ? ceil($totalLeads / $limit) : 1;
            $offset = ($page - 1) * $limit;
            
            // Build final query with sorting and pagination
            $orderByClause = '';
            if (in_array($sortBy, $validSortColumns)) {
                $orderByClause = " ORDER BY " . $sortBy . " " . $sortOrder;
            } else {
                // Default sorting
                $orderByClause = " ORDER BY l.date_modified DESC, l.date_created DESC";
            }
            
            $limitClause = " LIMIT ? OFFSET ?";
            
            // Prepare final query
            $selectQuery = $baseSelect . ' ' . $baseFrom . 
                         (!empty($filters) ? ' AND ' . implode(' AND ', $filters) : '') . 
                         $orderByClause . $limitClause;
            
            // Add pagination parameters
            $paginationParams = array_merge($params, [$limit, $offset]);
            $paginationTypes = $types . 'ii';
            
            // Prepare and execute the query
            $stmt = $conn->prepare($selectQuery);
            if (!$stmt) {
                throw new Exception('Failed to prepare statement: ' . $conn->error);
            }
            
            if (!empty($paginationParams)) {
                $stmt->bind_param($paginationTypes, ...$paginationParams);
            }
            // Execute the query
            if (!$stmt->execute()) {
                throw new Exception('Failed to execute query: ' . $stmt->error);
            }
            
            $result = $stmt->get_result();
            if (!$result) {
                throw new Exception('Failed to get result set: ' . $conn->error);
            }
            
            // Process results
            $leads = [];
            $leadIds = [];
            
            while ($row = $result->fetch_assoc()) {
                $lead = formatLeadRow($row);
                $leads[] = $lead;
                $leadIds[] = $lead['id'];
            }
            
            // Prepare the response
            $response['data'] = $leads;
            $response['meta']['pagination'] = [
                'total' => $totalLeads,
                'count' => count($leads),
                'per_page' => $limit,
                'current_page' => $page,
                'total_pages' => $totalPages,
                'has_more' => $page < $totalPages
            ];
            
            $response['meta']['filter'] = [
                'status' => $status,
                'search' => $search,
                'assigned_to' => $assignedTo,
                'source' => $source,
                'date_from' => $dateFrom,
                'date_to' => $dateTo,
                'sort_by' => $sortBy,
                'sort_order' => strtolower($sortOrder)
            ];
            
            // Include related data if requested
            if (in_array('stats', $includeRelated) && !empty($leadIds)) {
                // For now, just pass the first lead ID until we implement multi-lead stats
                $firstLeadId = is_array($leadIds) ? reset($leadIds) : $leadIds;
                $response['meta']['stats'] = getLeadStats($firstLeadId, ['conn' => $conn]);
            }
            
            // Add break to prevent fall-through to 'get' case
            break;
            
        case 'get':
        default:
            // Get single lead details with comprehensive data
            $lead = getLeadById($conn, $leadId, ['user_id' => $_SESSION['user_id']]);
            
            if (!$lead) {
                http_response_code(404);
                echo json_encode([
                    'success' => false,
                    'error' => 'Lead not found or access denied',
                    'code' => 'LEAD_NOT_FOUND',
                    'lead_id' => $leadId
                ]);
                exit;
            }
            
            // Add lead to response
            $response['data'] = $lead;
            
            // Include related data if requested
            if (!empty($includeRelated)) {
                $relatedData = [];
                
                // Get activities if requested
                if (in_array('activities', $includeRelated)) {
                    $relatedData['activities'] = getLeadActivities($conn, $leadId, $_SESSION['user_id']);
                }
                
                // Get notes if requested
                if (in_array('notes', $includeRelated)) {
                    $relatedData['notes'] = getLeadNotes($conn, $leadId, $_SESSION['user_id']);
                }
                
                // Get files if requested
                if (in_array('files', $includeRelated)) {
                    $relatedData['files'] = getLeadFiles($leadId, ['conn' => $conn, 'userId' => $_SESSION['user_id']]);
                }
                
                // Get tasks if requested
                if (in_array('tasks', $includeRelated)) {
                    $relatedData['tasks'] = getLeadTasks($conn, $leadId, $_SESSION['user_id']);
                }
                
                // Get emails if requested
                if (in_array('emails', $includeRelated)) {
                    $relatedData['emails'] = getLeadEmails($leadId, ['conn' => $conn, 'userId' => $_SESSION['user_id']]);
                }
                
                // Get calls if requested
                if (in_array('calls', $includeRelated)) {
                    $relatedData['calls'] = getLeadCalls($leadId, ['conn' => $conn, 'userId' => $_SESSION['user_id']]);
                }
                
                // Get meetings if requested
                if (in_array('meetings', $includeRelated)) {
                    $relatedData['meetings'] = getLeadMeetings($leadId, ['conn' => $conn, 'userId' => $_SESSION['user_id']]);
                }
                
                // Get documents if requested
                if (in_array('documents', $includeRelated)) {
                    $relatedData['documents'] = getLeadDocuments($conn, $leadId, $_SESSION['user_id']);
                }
                
                // Get history if requested
                if (in_array('history', $includeRelated)) {
                    $relatedData['history'] = getLeadHistory($leadId, ['conn' => $conn, 'userId' => $_SESSION['user_id']]);
                }
                
                // Add related data to included array
                foreach ($relatedData as $type => $items) {
                    if (!empty($items)) {
                        $response['included'] = array_merge(
                            $response['included'] ?? [],
                            array_map(function($item) use ($type) {
                                $item['type'] = $type;
                                return $item;
                            }, $items)
                        );
                    }
                }
            }
            
            // Update last viewed timestamp
            updateLastViewed($leadId, [
                'conn' => $conn, 
                'userId' => $_SESSION['user_id'],
                'entityType' => 'lead'
            ]);
            
            // Check if user has access to this lead
            $isAdmin = in_array($_SESSION['user_role'], ['admin', 'manager']);
            $isAssigned = ($_SESSION['user_id'] == $lead['assigned_to_id']);
            $isCreator = ($_SESSION['user_id'] == $lead['created_by']);
            
            if (!$isAdmin && !$isAssigned && !$isCreator) {
                http_response_code(403);
                echo json_encode(['success' => false, 'error' => 'You do not have permission to view this lead']);
                exit;
            }
            
            // Get lead activities
            $activities = [];
            $stmt = $conn->prepare("
                SELECT 
                    la.*, 
                    u.id as user_id,
                    u.name as user_name,
                    u.email as user_email,
                    u.role as user_role,
                    u.profile_image,
                    CONCAT(u.first_name, ' ', u.last_name) as user_fullname
                FROM lead_activities la
                JOIN users u ON la.user_id = u.id
                WHERE la.lead_id = ?
                ORDER BY la.created_at DESC
                LIMIT 100
            ");
            $stmt->bind_param("i", $leadId);
            $stmt->execute();
            $result = $stmt->get_result();
            
            while ($row = $result->fetch_assoc()) {
                $activities[] = [
                    'id' => (int)$row['id'],
                    'type' => $row['activity_type'],
                    'details' => $row['activity_details'],
                    'created_at' => $row['created_at'],
                    'user' => [
                        'id' => (int)$row['user_id'],
                        'name' => $row['user_name'],
                        'full_name' => $row['user_fullname'],
                        'email' => $row['user_email'],
                        'role' => $row['user_role'],
                        'profile_image' => $row['profile_image'] ?: getDefaultAvatar($row['user_name'])
                    ]
                ];
            }
            
            // Get lead tasks
            $tasks = [];
            $stmt = $conn->prepare("
                SELECT 
                    t.*,
                    u.name as assigned_to_name,
                    u.email as assigned_to_email,
                    CONCAT(u.first_name, ' ', u.last_name) as assigned_to_fullname
                FROM tasks t
                LEFT JOIN users u ON t.assigned_to = u.id
                WHERE t.lead_id = ? AND t.status != 'completed'
                ORDER BY t.due_date ASC, t.priority DESC
            ");
            $stmt->bind_param("i", $leadId);
            $stmt->execute();
            $result = $stmt->get_result();
            
            while ($row = $result->fetch_assoc()) {
                $tasks[] = [
                    'id' => (int)$row['id'],
                    'title' => $row['title'],
                    'description' => $row['description'],
                    'status' => $row['status'],
                    'priority' => $row['priority'],
                    'due_date' => $row['due_date'],
                    'created_at' => $row['created_at'],
                    'assigned_to' => [
                        'id' => (int)$row['assigned_to'],
                        'name' => $row['assigned_to_name'],
                        'full_name' => $row['assigned_to_fullname'],
                        'email' => $row['assigned_to_email']
                    ]
                ];
            }
            
            // Get lead notes
            $notes = [];
            $stmt = $conn->prepare("
                SELECT 
                    n.*,
                    u.name as created_by_name,
                    u.email as created_by_email,
                    CONCAT(u.first_name, ' ', u.last_name) as created_by_fullname
                FROM lead_notes n
                JOIN users u ON n.created_by = u.id
                WHERE n.lead_id = ?
                ORDER BY n.created_at DESC
            ");
            $stmt->bind_param("i", $leadId);
            $stmt->execute();
            $result = $stmt->get_result();
            
            while ($row = $result->fetch_assoc()) {
                $notes[] = [
                    'id' => (int)$row['id'],
                    'content' => $row['content'],
                    'is_private' => (bool)$row['is_private'],
                    'created_at' => $row['created_at'],
                    'created_by' => [
                        'id' => (int)$row['created_by'],
                        'name' => $row['created_by_name'],
                        'full_name' => $row['created_by_fullname'],
                        'email' => $row['created_by_email']
                    ]
                ];
            }
            
            // Get lead files
            $files = [];
            $stmt = $conn->prepare("
                SELECT 
                    f.*,
                    u.name as uploaded_by_name,
                    CONCAT(u.first_name, ' ', u.last_name) as uploaded_by_fullname
                FROM lead_files f
                JOIN users u ON f.uploaded_by = u.id
                WHERE f.lead_id = ?
                ORDER BY f.uploaded_at DESC
            ");
            $stmt->bind_param("i", $leadId);
            $stmt->execute();
            $result = $stmt->get_result();
            
            while ($row = $result->fetch_assoc()) {
                $files[] = [
                    'id' => (int)$row['id'],
                    'name' => $row['original_name'],
                    'path' => $row['file_path'],
                    'size' => (int)$row['file_size'],
                    'type' => $row['file_type'],
                    'uploaded_at' => $row['uploaded_at'],
                    'uploaded_by' => [
                        'id' => (int)$row['uploaded_by'],
                        'name' => $row['uploaded_by_name'],
                        'full_name' => $row['uploaded_by_fullname']
                    ]
                ];
            }
            
            // Get related deals
            $deals = [];
            $stmt = $conn->prepare("
                SELECT 
                    d.*,
                    s.name as stage_name,
                    s.probability,
                    u.name as owner_name,
                    CONCAT(u.first_name, ' ', u.last_name) as owner_fullname
                FROM deals d
                JOIN deal_stages s ON d.stage_id = s.id
                LEFT JOIN users u ON d.owner_id = u.id
                WHERE d.lead_id = ?
                ORDER BY d.expected_close_date ASC
            ");
            $stmt->bind_param("i", $leadId);
            $stmt->execute();
            $result = $stmt->get_result();
            
            while ($row = $result->fetch_assoc()) {
                $deals[] = [
                    'id' => (int)$row['id'],
                    'name' => $row['name'],
                    'amount' => (float)$row['amount'],
                    'stage' => [
                        'id' => (int)$row['stage_id'],
                        'name' => $row['stage_name'],
                        'probability' => (float)$row['probability']
                    ],
                    'expected_close_date' => $row['expected_close_date'],
                    'created_at' => $row['created_at'],
                    'owner' => [
                        'id' => (int)$row['owner_id'],
                        'name' => $row['owner_name'],
                        'full_name' => $row['owner_fullname']
                    ]
                ];
            }
            
            // Format the lead data
            $leadData = formatLeadRow($lead);
            $leadData['activities'] = $activities;
            $leadData['tasks'] = $tasks;
            $leadData['notes'] = $notes;
            $leadData['files'] = $files;
            $leadData['deals'] = $deals;
            
            // Add permissions
            $leadData['permissions'] = [
                'can_edit' => $isAdmin || $isAssigned || $isCreator,
                'can_delete' => $isAdmin || $isCreator,
                'can_assign' => $isAdmin || $isAssigned || $isCreator,
                'can_convert' => $isAdmin || $isAssigned || $isCreator
            ];
            
            // Return the complete lead data
            echo json_encode([
                'success' => true,
                'data' => $leadData
            ]);
            exit;
    }
    
} catch (Exception $e) {
    // Rollback transaction on error
    if (isset($conn) && $conn) {
        $conn->rollback();
    }
    
    // Log the error
    error_log('Error in get_lead_details.php: ' . $e->getMessage() . ' in ' . $e->getFile() . ' on line ' . $e->getLine());
    
    // Send error response
    http_response_code(500);
    echo json_encode([
        'success' => false,
        'error' => 'An unexpected error occurred',
        'code' => 'INTERNAL_SERVER_ERROR',
        'request_id' => uniqid('req_', true)
    ], JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);
}
