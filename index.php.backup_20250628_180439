<?php
/**
 * APS Dream Home - Main Index File
 * 
 * This is the main entry point for the APS Dream Home website.
 */

// Define application start time for performance measurement
$start_time = microtime(true);

// Set error reporting based on environment
if (getenv('ENVIRONMENT') === 'development') {
    ini_set('display_errors', 1);
    error_reporting(E_ALL);
} else {
    ini_set('display_errors', 0);
    error_reporting(E_ALL & ~E_DEPRECATED);
}

// Define application paths
define('APP_ROOT', __DIR__);
define('INCLUDES_DIR', APP_ROOT . '/includes');

// Load configuration and functions
require_once INCLUDES_DIR . '/config.php';
require_once INCLUDES_DIR . '/functions/common.php';
require_once INCLUDES_DIR . '/functions/template.php';

// Start secure session
start_secure_session(SESSION_NAME);

// Set default timezone
date_default_timezone_set('Asia/Kolkata');

// Load the database configuration class
require_once INCLUDES_DIR . '/config/DatabaseConfig.php';

// Load models
require_once INCLUDES_DIR . '/models/PropertyModel.php';

// Initialize database connection
try {
    $conn = DatabaseConfig::getConnection();
    if ($conn === null) {
        throw new Exception('Failed to establish database connection. Check logs for details.');
    }
    log_message('Database connection established successfully', 'info');
} catch (Exception $e) {
    log_message('Database connection failed: ' . $e->getMessage(), 'error');
    http_response_code(503);
    include INCLUDES_DIR . '/templates/errors/503.php';
    exit;
}

// Get featured properties
try {
    $propertyModel = new PropertyModel($conn);
    $featured_properties = $propertyModel->getFeaturedProperties(9);
    
    // Cache the results for 1 hour if there are featured properties
    if (!empty($featured_properties)) {
        $cache = Cache::getInstance();
        $cache->set('featured_properties', $featured_properties, 3600);
    }
} catch (Exception $e) {
    log_message('Error fetching featured properties: ' . $e->getMessage(), 'error');
    $featured_properties = [];
}

// Get property counts
try {
    $counts = $propertyModel->getPropertyCounts();
} catch (Exception $e) {
    log_message('Error fetching property counts: ' . $e->getMessage(), 'error');
    $counts = [
        'total_properties' => 0,
        'sold_properties' => 0,
        'happy_customers' => 0,
        'agents_count' => 0
    ];
}

// Prepare page data
$page_data = [
    'title' => 'Find Your Dream Home | APS Dream Home',
    'description' => 'Discover your perfect home with APS Dream Home. Browse our exclusive collection of properties for sale and rent in prime locations across India.',
    'keywords' => 'real estate, property, home for sale, apartments, villas, real estate agent, property in India, buy property, rent property',
    'canonical_url' => get_canonical_url(),
    'featured_properties' => $featured_properties,
    'counts' => $counts,
    'stats' => [
        'properties' => [
            'total' => $counts['total_properties'],
            'sold' => $counts['sold_properties'],
            'featured' => count($featured_properties)
        ],
        'agents' => $counts['agents_count'],
        'happy_customers' => $counts['happy_customers']
    ]
];

// Check for maintenance mode
if (MAINTENANCE_MODE === true && !in_array($_SERVER['REMOTE_ADDR'], explode(',', ALLOWED_IPS))) {
    http_response_code(503);
    include INCLUDES_DIR . '/templates/errors/maintenance.php';
    exit;
}

// Start output buffering
ob_start();

// Include header template
include INCLUDES_DIR . '/templates/header.php';

// Include hero section
include INCLUDES_DIR . '/templates/sections/hero.php';

// Include property search
include INCLUDES_DIR . '/templates/sections/property-search.php';

// Include featured properties
if (!empty($featured_properties)) {
    include INCLUDES_DIR . '/templates/sections/featured-properties.php';
}

// Include services
include INCLUDES_DIR . '/templates/sections/services.php';

// Include testimonials
include INCLUDES_DIR . '/templates/sections/testimonials.php';

// Include call to action
include INCLUDES_DIR . '/templates/sections/cta.php';

// Include footer
include INCLUDES_DIR . '/templates/footer.php';

// Get the buffer and clean it
$output = ob_get_clean();

// Minify HTML output if not in development mode
if (ENVIRONMENT === 'production') {
    $output = minify_html($output);
}

// Add performance metrics in development mode
if (ENVIRONMENT === 'development') {
    $end_time = microtime(true);
    $execution_time = ($end_time - $start_time);
    $memory_usage = memory_get_peak_usage(true) / 1024 / 1024; // MB
    
    $performance_metrics = sprintf(
        "<!-- Page generated in %.4f seconds using %.2fMB of memory -->",
        $execution_time,
        $memory_usage
    );
    
    // Append before closing body tag
    $output = str_replace('</body>', $performance_metrics . '\n</body>', $output);
}

// Output the final HTML
echo $output;

// Close database connection
if (isset($con) && $con instanceof mysqli) {
    $con->close();
}

exit;
