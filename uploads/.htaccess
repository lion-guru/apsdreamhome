# Enhanced Security .htaccess for Uploads Directory
# Prevents direct access to uploaded files and adds security measures

# ===================================================================
# UPLOADS DIRECTORY PROTECTION
# ===================================================================

# Disable directory listing
Options -Indexes

# Prevent access to this directory
<RequireAll>
    Require all denied
</RequireAll>

# Block all HTTP methods except GET for specific files
<LimitExcept GET>
    Require all denied
</LimitExcept>

# ===================================================================
# FILE TYPE RESTRICTIONS
# ===================================================================

# Block dangerous file types
<FilesMatch "\.(php|php3|php4|php5|phtml|pl|cgi|py|jsp|asp|htm|shtml|sh|csh|exe|com|bat|cmd|pif|scr|vbs|js|jar|msi)$">
    Require all denied
</FilesMatch>

# Block files with multiple extensions (potential PHP files)
RewriteEngine On
RewriteCond %{REQUEST_URI} \..*\..*
RewriteRule ^ - [F,L]

# Block PHP files disguised with different extensions
RewriteCond %{REQUEST_FILENAME} \.php\.
RewriteRule ^ - [F,L]

# ===================================================================
# SECURITY HEADERS FOR UPLOADS
# ===================================================================
<IfModule headers_module>
    # Security headers for uploaded content
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"

    # Prevent MIME type sniffing for uploaded files
    <FilesMatch "\.(jpg|jpeg|png|gif|pdf|doc|docx|xls|xlsx|ppt|pptx|txt|csv|zip|rar)$">
        Header set X-Content-Type-Options "nosniff"
    </FilesMatch>

    # Cache control for uploaded files
    Header set Cache-Control "private, max-age=3600"
    Header set Pragma "cache"
</IfModule>

# ===================================================================
# SIZE LIMITATIONS
# ===================================================================
# Limit file size for uploads (adjust as needed)
LimitRequestBody 10485760  # 10MB limit

# ===================================================================
# ACCESS LOGGING
# ===================================================================
# Log all access attempts to uploads directory
CustomLog logs/uploads_access.log common

# ===================================================================
# HOTLINK PROTECTION (Optional)
# ===================================================================
# Prevent hotlinking of uploaded files
RewriteCond %{HTTP_REFERER} !^https?://(www\.)?yourdomain\.com [NC]
RewriteCond %{REQUEST_FILENAME} \.(jpg|jpeg|png|gif|pdf|doc|docx)$ [NC]
RewriteRule ^(.*)$ - [F,L]

# ===================================================================
# MALWARE SCANNING (Basic)
# ===================================================================
# Block files with suspicious patterns in filename
RewriteCond %{REQUEST_FILENAME} (eval|base64|cmd|exec|system|shell|phpinfo|passthru|proc_open|popen) [NC]
RewriteRule ^ - [F,L]

# ===================================================================
# RATE LIMITING FOR DOWNLOADS
# ===================================================================
<IfModule ratelimit_module>
    # Limit download rate for large files
    <FilesMatch "\.(zip|rar|pdf|doc|docx|xls|xlsx)$">
        SetEnv RATE_LIMIT 500
    </FilesMatch>
</IfModule>
