# ===========================================
# Security Headers and Basic Settings
# ===========================================

# Disable server signature
ServerSignature Off

# Disable directory listing
Options -Indexes

# Default charset
AddDefaultCharset UTF-8

# Set timezone (change to your timezone)
SetEnv TZ Asia/Kolkata

# ===========================================
# PHP Settings
# ===========================================
<IfModule mod_php7.c>
    # Only enable errors in development
    php_flag display_startup_errors off
    php_flag display_errors off
    php_flag html_errors off
    
    # Log errors instead of displaying them
    php_flag log_errors on
    php_value error_log /path/to/php_errors.log
    
    # Error reporting level (E_ALL & ~E_NOTICE & ~E_DEPRECATED)
    php_value error_reporting 22527
    
    # Security settings
    php_flag session.cookie_httponly on
    php_flag session.cookie_secure on
    php_flag session.use_only_cookies on
    php_value session.cookie_samesite "Lax"
</IfModule>

# ===========================================
# URL Rewriting
# ===========================================
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Force HTTPS
    # RewriteCond %{HTTPS} off
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # Redirect www to non-www (or vice versa)
    # RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
    # RewriteRule ^(.*)$ https://%1/$1 [R=301,L]
    
    # Redirect index.php to root
    RewriteCond %{THE_REQUEST} ^[A-Z]{3,9}\ /index\.php\ HTTP/
    RewriteRule ^index\.php$ / [R=301,L]
</IfModule>

# ===========================================
# Protect Sensitive Files
# ===========================================
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

<FilesMatch "\.(env|config|log|sql|ini|htaccess|htpasswd|bak|swp|gitignore|gitattributes|gitmodules)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# ===========================================
# Security Headers
# ===========================================
<IfModule mod_headers.c>
    # Security Headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Content Security Policy
    # Note: You'll need to adjust this based on your specific needs
    # Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; media-src 'self'; object-src 'none'; frame-ancestors 'self'; form-action 'self'; base-uri 'self';"
    
    # HTTP Strict Transport Security (HSTS)
    # Uncomment after you've set up SSL
    # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Feature Policy
    Header set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # Remove X-Powered-By header
    Header unset X-Powered-By
    
    # Remove X-PHP-Originating-Script header
    Header unset X-PHP-Originating-Script
    
    # Remove X-PHP-Script header
    Header unset X-PHP-Script
    
    # Remove X-PHP-* headers
    <FilesMatch "\.(php|phps)$">
        Header unset X-PHP-*
    </FilesMatch>
</IfModule>

# ===========================================
# File Access Control
# ===========================================
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|tpl|txt|xml|json|lock|md|gitignore|gitattributes|env|example)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Protect specific directories
<DirectoryMatch "^/?(app|config|database|logs|storage|vendor|node_modules|tests|tmp)/">
    Order allow,deny
    Deny from all
</DirectoryMatch>

# ===========================================
# MIME Type Security
# ===========================================
<IfModule mod_mime.c>
    # Disable PHP execution in uploads
    <FilesMatch "\.(php|phar|phtml|shtml|cgi|pl|exe|php3|php4|php5|php7|php8|php9|phps|pht|phtm|phar|shtml|phpt|pwml|inc|asp|aspx|ascx|jsp|jspa|jspx|jsw|jsv|jspf|jsp|jhtml|inc|phtml|cfm|cfc|pl|bat|exe|com|dll|vbs|hta|cgi|htaccess|htpasswd|ini|log|sh|sql|tpl|txt|xml|json|lock|md|gitignore|gitattributes|env|example)$">
        ForceType text/plain
    </FilesMatch>
    
    # Proper MIME type for common files
    AddType application/javascript          js jsonp
    AddType application/json                json
    AddType text/cache-manifest             appcache manifest
    AddType text/plain                     txt md
    AddType application/xml                 rss atom xml rdf
    AddType application/octet-stream        safariextz
    AddType text/x-component                htc
    AddType image/webp                      webp
    AddType image/x-icon                    ico cur
    AddType image/svg+xml                   svg svgz
    AddType application/vnd.ms-fontobject   eot
    AddType application/x-font-ttf          ttf ttc
    AddType font/opentype                  otf
    AddType application/x-font-woff         woff
    AddType application/x-font-woff2        woff2
    AddType application/x-font-ttf          ttf
    AddType application/x-font-otf          otf
    AddType application/font-woff           woff
    AddType application/font-woff2          woff2
    AddType application/vnd.ms-fontobject   eot
    AddType application/x-font-ttf          ttc ttf
    AddType font/opentype                   otf
    AddType font/ttf                        ttf
    AddType font/otf                        otf
    AddType font/woff                       woff
    AddType font/woff2                      woff2
</IfModule>

# ===========================================
# Compression
# ===========================================
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE font/opentype font/ttf font/eot font/otf
    
    # Remove browser bugs (only needed for really old browsers)
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    
    # Ensure proxies deliver compressed content correctly
    Header append Vary User-Agent
</IfModule>

# ===========================================
# Expires Headers
# ===========================================
<IfModule mod_expires.c>
    ExpiresActive on
    ExpiresDefault                                      "access plus 1 month"
    
    # CSS
    ExpiresByType text/css                              "access plus 1 year"
    
    # Data interchange
    ExpiresByType application/atom+xml                  "access plus 1 hour"
    ExpiresByType application/rdf+xml                   "access plus 1 hour"
    ExpiresByType application/rss+xml                   "access plus 1 hour"
    ExpiresByType application/json                      "access plus 0 seconds"
    ExpiresByType application/ld+json                   "access plus 0 seconds"
    ExpiresByType application/schema+json               "access plus 0 seconds"
    ExpiresByType application/vnd.geo+json              "access plus 0 seconds"
    ExpiresByType application/xml                       "access plus 0 seconds"
    ExpiresByType text/xml                              "access plus 0 seconds"
    
    # Favicon (cannot be renamed!) and cursor images
    ExpiresByType image/vnd.microsoft.icon              "access plus 1 week"
    ExpiresByType image/x-icon                          "access plus 1 week"
    
    # HTML
    ExpiresByType text/html                             "access plus 0 seconds"
    
    # JavaScript
    ExpiresByType application/javascript                "access plus 1 year"
    ExpiresByType application/x-javascript              "access plus 1 year"
    ExpiresByType text/javascript                       "access plus 1 year"
    
    # Manifest files
    ExpiresByType application/manifest+json             "access plus 1 year"
    ExpiresByType application/x-web-app-manifest+json   "access plus 0 seconds"
    ExpiresByType text/cache-manifest                   "access plus 0 seconds"
    
    # Media files
    ExpiresByType audio/ogg                             "access plus 1 year"
    ExpiresByType image/bmp                             "access plus 1 year"
    ExpiresByType image/gif                             "access plus 1 year"
    ExpiresByType image/jpeg                            "access plus 1 year"
    ExpiresByType image/png                             "access plus 1 year"
    ExpiresByType image/svg+xml                         "access plus 1 year"
    ExpiresByType image/webp                            "access plus 1 year"
    ExpiresByType video/mp4                             "access plus 1 year"
    ExpiresByType video/ogg                             "access plus 1 year"
    ExpiresByType video/webm                            "access plus 1 year"
    
    # Web fonts
    ExpiresByType application/vnd.ms-fontobject         "access plus 1 year"
    ExpiresByType font/eot                              "access plus 1 year"
    ExpiresByType font/opentype                         "access plus 1 year"
    ExpiresByType application/x-font-ttf                "access plus 1 year"
    ExpiresByType application/font-woff                 "access plus 1 year"
    ExpiresByType application/x-font-woff               "access plus 1 year"
    ExpiresByType font/woff                             "access plus 1 year"
    ExpiresByType application/font-woff2                "access plus 1 year"
    ExpiresByType font/woff2                            "access plus 1 year"
    
    # Other
    ExpiresByType text/x-cross-domain-policy            "access plus 1 week"
</IfModule>
