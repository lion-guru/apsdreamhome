RewriteEngine On
Options -Indexes

# Set the base path for admin
RewriteBase /apsdreamhome/admin/

# Add cache control to prevent redirect caching
<IfModule mod_headers.c>
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
</IfModule>

# Allow direct access to all dashboard files and admin pages
RewriteCond %{REQUEST_URI} ^/admin/(.*\.php)$ [NC]
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^(.*)$ $1 [L]

# Allow POST requests to process_login.php but block direct GET access
RewriteCond %{REQUEST_METHOD} ^GET$
RewriteCond %{REQUEST_URI} ^/admin/process_login\.php$ [NC]
RewriteRule ^(.*)$ - [F,L]

# Prevent direct access to other sensitive files
<FilesMatch "^(config\.php|\.htaccess|admin_login_handler\.php)$">
    Require all denied
</FilesMatch>

# For everything else, redirect to login
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php [L,QSA]