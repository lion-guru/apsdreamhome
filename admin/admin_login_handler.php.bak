<?php
// Enhanced Admin Login Handler
require_once __DIR__ . '/../includes/AuthMiddleware.php';
require_once __DIR__ . '/../includes/SecurityUtility.php';
require_once __DIR__ . '/../includes/AdminLogger.php';

// Start secure session
session_start([
    'cookie_httponly' => true,
    'cookie_secure' => true,
    'use_strict_mode' => true
]);

// Process login form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Validate CSRF token
    if (!SecurityUtility::validateCSRFToken($_POST['csrf_token'] ?? '')) {
        AdminLogger::securityAlert('CSRF_TOKEN_MISMATCH', [
            'ip' => $_SERVER['REMOTE_ADDR'] ?? 'Unknown'
        ]);
        $_SESSION['login_error'] = 'Invalid security token';
        header('Location: login.php');
        exit();
    }

    // Validate CAPTCHA
    $captchaAnswer = $_SESSION['captcha_answer'] ?? null;
    $userCaptchaResponse = $_POST['captcha_response'] ?? null;

    if ($captchaAnswer === null || $userCaptchaResponse === null || 
        (int)$userCaptchaResponse !== $captchaAnswer) {
        AdminLogger::log('CAPTCHA_VALIDATION_FAILED', [
            'ip' => $_SERVER['REMOTE_ADDR'] ?? 'Unknown'
        ]);
        $_SESSION['login_error'] = 'Invalid CAPTCHA response';
        header('Location: login.php');
        exit();
    }

    // Sanitize and validate inputs
    $username = SecurityUtility::sanitizeInput($_POST['username'], 'username');
    $password = SecurityUtility::sanitizeInput($_POST['password'], 'password');

    // Attempt authentication
    if (AuthMiddleware::validateAdminCredentials($username, $password)) {
        // Successful login
        header('Location: dashboard.php');
        exit();
    } else {
        // Failed login
        $_SESSION['login_error'] = 'Invalid credentials';
        header('Location: login.php');
        exit();
    }
}

// Ensure session is started
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

// Autoload required classes and utilities
require_once __DIR__ . '/../includes/password_utils.php';

// Custom exception for validation errors
class ValidationException extends Exception {
    public function __construct($message, $code = 0, ?Exception $previous = null) {
        parent::__construct($message, $code, $previous);
    }
}

// Logging function for admin actions
function logAdminAction($data) {
    // Implement logging logic here
    // Could log to file, database, or external service
    error_log('Admin Action: ' . json_encode($data));
}

class AdminLoginHandler {
    const SESSION_TIMEOUT = 1800; // 30 minutes

    public static function login($username, $password) {
        try {
            // Validate login attempt
            if (!self::validateLoginAttempt($username, $password)) {
                return [
                    'status' => 'error',
                    'message' => 'Invalid login attempt'
                ];
            }

            // Fetch user from database (replace with actual database logic)
            $user = self::getUserByUsername($username);

            if (!$user || !password_verify($password, $user['apass'])) {
                // Log failed login attempt
                logAdminAction([
                    'action' => 'login_failed',
                    'username' => $username,
                    'ip_address' => $_SERVER['REMOTE_ADDR']
                ]);

                return [
                    'status' => 'error',
                    'message' => 'Invalid username or password'
                ];
            }

            // Successful login
            return self::createSession($user);

        } catch (Exception $e) {
            // Log unexpected errors
            self::logError('login_error', $e->getMessage());
            return [
                'status' => 'error',
                'message' => 'An unexpected error occurred'
            ];
        }
    }

    private static function validateLoginAttempt($username, $password) {
        // Basic validation
        return !empty($username) && !empty($password) && 
               strlen($username) >= 3 && 
               preg_match('/^[a-zA-Z0-9_]+$/', $username);
    }

    private static function getUserByUsername($username) {
        // Replace with actual database query
        // This is a placeholder implementation
        return [
            'id' => 1,
            'auser' => $username,
            'apass' => password_hash('placeholder_password', PASSWORD_DEFAULT),
            'role' => 'admin'
        ];
    }

    private static function createSession($user) {
        // Regenerate session ID for security
        session_regenerate_id(true);

        // Set session variables
        $_SESSION['admin_session'] = [
            'is_authenticated' => true,
            'user_id' => $user['id'],
            'username' => $user['auser'],
            'role' => $user['role'],
            'last_activity' => time()
        ];

        // Log successful login
        logAdminAction([
            'action' => 'login_success',
            'username' => $user['auser'],
            'ip_address' => $_SERVER['REMOTE_ADDR']
        ]);

        return [
            'status' => 'success',
            'message' => 'Login successful',
            'redirect' => self::getDashboardForRole($user['role'])
        ];
    }

    private static function getDashboardForRole($role) {
        switch ($role) {
            case 'superadmin': return 'superadmin_dashboard.php';
            case 'admin': return 'dashboard.php';
            case 'manager': return 'manager_dashboard.php';
            default: return 'login.php';
        }
    }

    public static function checkSession() {
        // Validate existing session
        if (!isset($_SESSION['admin_session']['is_authenticated']) || 
            !$_SESSION['admin_session']['is_authenticated']) {
            return [
                'status' => 'error',
                'message' => 'No active session'
            ];
        }

        // Check session timeout
        $currentTime = time();
        $lastActivity = $_SESSION['admin_session']['last_activity'] ?? 0;
        if ($currentTime - $lastActivity > self::SESSION_TIMEOUT) {
            self::terminateSession();
            return [
                'status' => 'error',
                'message' => 'Session expired'
            ];
        }

        // Update last activity
        $_SESSION['admin_session']['last_activity'] = $currentTime;

        return [
            'status' => 'success',
            'message' => 'Session is active'
        ];
    }

    public static function terminateSession() {
        // Clear all session data
        $_SESSION = array();
        // Destroy the session cookie
        if (isset($_COOKIE[session_name()])) {
            setcookie(session_name(), '', time() - 3600, '/');
        }
        // Destroy the session
        session_destroy();
        return true;
    }

    private static function logError($type, $message) {
        error_log("[{$type}] {$message}");
    }
}
/**
 * Enhanced Admin Login Handler
 * Provides secure authentication with session management
 */

require_once __DIR__ . '/../includes/db_config.php';
require_once __DIR__ . '/includes/session_manager.php';
require_once __DIR__ . '/includes/csrf_protection.php';
require_once __DIR__ . '/../includes/password_utils.php';

// Define ValidationException class if not already defined
class ValidationException extends Exception {
    // Custom exception for validation errors
    public function __construct($message, $code = 0, ?Exception $previous = null) {
        parent::__construct($message, $code, $previous);
    }
}

// Define logAdminAction function if not already defined elsewhere
if (!function_exists('logAdminAction')) {
    function logAdminAction($data) {
        // Log to error log
        error_log("[Admin Action] " . json_encode($data));
        
        // If you have a database logging function, you can call it here
        if (function_exists('log_admin_action_db')) {
            log_admin_action_db('admin_action', json_encode($data));
        }
    }
}

// Initialize session with proper security settings
// Remove or replace this if not defined:
// initAdminSession();

// End of file

<?php
// New AdminLoginHandler class with all methods
class AdminLoginHandlerNew {
    private const SESSION_TIMEOUT = 1800; // 30 minutes
    
    public static function handleLogin() {
        try {
            if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
                header('Location: index.php');
                exit();
            }
            
            // CAPTCHA validation
            $captcha_answer = filter_input(INPUT_POST, 'captcha_answer', FILTER_VALIDATE_INT);
            if (!isset($_SESSION['captcha_num1_admin']) || !isset($_SESSION['captcha_num2_admin']) || 
                $captcha_answer !== ($_SESSION['captcha_num1_admin'] + $_SESSION['captcha_num2_admin'])) {
                $_SESSION['login_error'] = 'Invalid security answer';
                header('Location: index.php');
                exit();
            }
            
            $username = filter_input(INPUT_POST, 'username', FILTER_SANITIZE_FULL_SPECIAL_CHARS) ?? '';
            $password = filter_input(INPUT_POST, 'password', FILTER_UNSAFE_RAW) ?? '';
            
            if (empty($username) || empty($password)) {
                $_SESSION['login_error'] = 'Please fill in all fields';
                header('Location: index.php');
                exit();
            }

        // Use getDbConnection() to connect to DB
        $con = $con;
        if (!$con) {
            $_SESSION['login_error'] = 'Database connection error';
            header('Location: index.php');
            exit();
        }

        $stmt = null;
        
        try {
            // Use the unified 'admin' table for all official admin logins
            $stmt = $con->prepare("SELECT id, auser, apass, role, status FROM admin WHERE auser = ? LIMIT 1");
            $stmt->bind_param("s", $username);
            $stmt->execute();
            $result = $stmt->get_result();
            
            // Check if user exists
            if ($result->num_rows === 0) {
                $_SESSION['login_error'] = 'Invalid username or password';
                header('Location: index.php');
                exit();
            }
            
            // Fetch user details
            $user = $result->fetch_assoc();
            
            // Verify password
            require_once __DIR__ . '/../includes/password_utils.php';
            if (!PasswordUtils::verifyPassword($password, $user['apass'])) {
                $_SESSION['login_error'] = 'Invalid username or password';
                header('Location: index.php');
                exit();
            }
            
            // Check user status
            if ($user['status'] !== 'active') {
                $_SESSION['login_error'] = 'Account is not active';
                header('Location: index.php');
                exit();
            }
            
            // Successful login - set session
            $_SESSION['admin_session'] = [
                'is_authenticated' => true,
                'user_id' => $user['id'],
                'username' => $user['auser'],
                'role' => $user['role'],
                'last_activity' => time()
            ];
            
            // Redirect to dashboard
            header('Location: dashboard.php');
            exit();

            // Verify user credentials
            if ($result->num_rows === 1) {
                $user = $result->fetch_assoc();
                
                // Validate user roles
                $allowed_roles = [];
                $roleRes = $con->query('SELECT name FROM roles');
                while ($row = $roleRes->fetch_assoc()) {
                    $allowed_roles[] = $row['name'];
                }

                // Additional role validation
                if (!in_array($user['role'], $allowed_roles)) {
                    $_SESSION['login_error'] = 'Unauthorized role access';
                    logAdminAction([
                        'action' => 'unauthorized_role',
                        'username' => $username,
                        'attempted_role' => $user['role'],
                        'ip_address' => $_SERVER['REMOTE_ADDR']
                    ]);
                    header('Location: login.php');
                    exit();
                }

                if ($user['status'] !== 'active') {
                    $_SESSION['login_error'] = 'Account is not active.';
                    log_admin_action_db('admin_login_failed', 'Inactive account: ' . $username);
                    $con->close();
                    header('Location: login.php?debug=1');
                    exit();
                }

                if (password_verify($password, $user['apass'])) {
                    // Check if password needs rehashing
                    if (PasswordUtils::needsRehash($user['apass'])) {
                        // Rehash the password
                        $newHash = PasswordUtils::hashPassword($password);
                        
                        // Update the password in the database
                        $updateStmt = $con->prepare("UPDATE admin SET apass = ? WHERE id = ?");
                        $updateStmt->bind_param("si", $newHash, $user['id']);
                        $updateStmt->execute();
                        $updateStmt->close();
                    }
                    // Successful login
                    session_regenerate_id(true); // Prevent session fixation
                    
                    // Set comprehensive session data
                    $_SESSION['admin_logged_in'] = true;
                    $_SESSION['admin_id'] = $user['id'];
                    $_SESSION['admin_username'] = $user['auser'];
                    $_SESSION['admin_role'] = $user['role'];
                    $_SESSION['last_activity'] = time();
                    $_SESSION['created'] = time();

                    // Log successful login
                    logAdminAction([
                        'action' => 'login_success',
                        'username' => $user['auser'],
                        'ip_address' => $_SERVER['REMOTE_ADDR']
                    ]);

                    // Redirect based on user role
                    switch ($user['role']) {
                        case 'superadmin':
                            header('Location: superadmin_dashboard.php');
                            break;
                        case 'admin':
                            header('Location: dashboard.php');
                            break;
                        case 'manager':
                            header('Location: manager_dashboard.php');
                            break;
                        default:
                            header('Location: login.php');
                            $_SESSION['login_error'] = 'Unauthorized access';
                    }
                    exit();
                } else {
                    // Failed password verification
                    $_SESSION['login_error'] = 'Invalid username or password';
                    $_SESSION['admin_login_attempts'] = ($_SESSION['admin_login_attempts'] ?? 0) + 1;
                    
                    // Implement progressive lockout
                    if ($_SESSION['admin_login_attempts'] >= 5) {
                        $_SESSION['admin_login_blocked_until'] = time() + 600; // 10 minutes
                    }

                    // Log failed login attempt
                    logAdminAction([
                        'action' => 'login_failed',
                        'username' => $username,
                        'ip_address' => $_SERVER['REMOTE_ADDR']
                    ]);

                    header('Location: login.php');
                    exit();
                }
            } else {
                // User not found
                $_SESSION['login_error'] = 'Invalid username or password';
                $_SESSION['admin_login_attempts'] = ($_SESSION['admin_login_attempts'] ?? 0) + 1;
                if ($_SESSION['admin_login_attempts'] >= 5) {
                    $_SESSION['admin_login_blocked_until'] = time() + 600;
                    $_SESSION['login_error'] = 'Too many failed login attempts. Please try again after ' . date('H:i:s', $_SESSION['admin_login_blocked_until']);
                }
                log_admin_action_db('admin_login_failed', 'Failed login for username: ' . $username);
                $con->close();
                header('Location: login.php?debug=1');
                exit();
            }
        } catch (Exception $e) {
            $_SESSION['login_error'] = 'An error occurred. Please try again later.';
            $_SESSION['debug_login'] = [
                'exception' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ];
            if (isset($con) && $con) $con->close();
            header('Location: login.php?debug=1');
            exit();
        } finally {
            if (isset($stmt)) {
        }

        if (password_verify($password, $user['apass'])) {
            // Check if password needs rehashing
            if (PasswordUtils::needsRehash($user['apass'])) {
                // Rehash the password
                $newHash = PasswordUtils::hashPassword($password);

                // Update the password in the database
                $updateStmt = $con->prepare("UPDATE admin SET apass = ? WHERE id = ?");
                $updateStmt->bind_param("si", $newHash, $user['id']);
                $updateStmt->execute();
                $updateStmt->close();
            }

            // Successful login
            session_regenerate_id(true); // Prevent session fixation

            // Set comprehensive session data
            $_SESSION['admin_logged_in'] = true;
            $_SESSION['admin_id'] = $user['id'];
            $_SESSION['admin_username'] = $user['auser'];
            $_SESSION['admin_role'] = $user['role'];
            $_SESSION['last_activity'] = time();
            $_SESSION['created'] = time();

            // Log successful login
            logAdminAction([
                'action' => 'login_success',
                'username' => $user['auser'],
                'ip_address' => $_SERVER['REMOTE_ADDR']
            ]);

            // Redirect based on user role
            switch ($user['role']) {
                case 'superadmin':
                    header('Location: superadmin_dashboard.php');
                    break;
                case 'admin':
                    header('Location: dashboard.php');
                    break;
                case 'manager':
                    header('Location: manager_dashboard.php');
                    break;
                default:
                    header('Location: login.php');
                    $_SESSION['login_error'] = 'Unauthorized access';
            }
            exit();
        } else {
            // Failed password verification
            $_SESSION['login_error'] = 'Invalid username or password';
            $_SESSION['admin_login_attempts'] = ($_SESSION['admin_login_attempts'] ?? 0) + 1;
                    
            // Implement progressive lockout
            if ($_SESSION['admin_login_attempts'] >= 5) {
                $_SESSION['admin_login_blocked_until'] = time() + 600; // 10 minutes
            }

            // Log failed login attempt
            logAdminAction([
                'action' => 'login_failed',
                'username' => $username,
                'ip_address' => $_SERVER['REMOTE_ADDR']
            ]);

            header('Location: login.php');
            exit();
        }
    }
    
    // Handle user not found case
    private static function handleUserNotFound($username) {
        $_SESSION['login_error'] = 'Invalid username or password';
        $_SESSION['admin_login_attempts'] = ($_SESSION['admin_login_attempts'] ?? 0) + 1;
        
        if ($_SESSION['admin_login_attempts'] >= 5) {
            $_SESSION['admin_login_blocked_until'] = time() + 600;
            $_SESSION['login_error'] = 'Too many failed login attempts. Please try again after ' . date('H:i:s', $_SESSION['admin_login_blocked_until']);
        }
        
        if (!isset($_SESSION['admin_session'])) {
            self::initSession();
        }
        
        // Log failed login attempt
        logAdminAction([
            'action' => 'login_failed',
            'username' => $username,
            'ip_address' => $_SERVER['REMOTE_ADDR']
        ]);
        
        header('Location: login.php');
        exit();
    }
    
    private static function updateSessionActivity() {
        $_SESSION['admin_session']['last_activity'] = time();
        $_SESSION['admin_session']['is_authenticated'] = true;
        
        // Regenerate session ID after successful login
        session_regenerate_id(true);
        
        return array(
            'status' => 'success',
            'message' => 'Logged in successfully.'
        );
    }
    
    public static function terminateSession() {
        // Clear all session data
        $_SESSION = array();
        
        // Destroy the session cookie
        if (isset($_COOKIE[session_name()])) {
            setcookie(session_name(), '', time() - 3600, '/');
        }
        
        // Destroy the session
        session_destroy();
        return true;
    }
}
