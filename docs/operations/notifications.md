# MLM Notification Operations Guide

This document describes how the Phase 4 notification system works and how to operate it in production.

## Overview

Notifications are generated by the MLM services (commission approval and payout automation). All messages are sent via email in the current phase and recorded in `mlm_notification_log` for auditing.

Channels supported now:
- Email (default, via PHP `mail()`)

Planned extensions:
- WhatsApp (leverages existing `includes/whatsapp_integration.php`)
- SMS (Twilio or local provider)

## Trigger Matrix

| Event | Trigger Service | Audience | Template | Log Type |
| --- | --- | --- | --- | --- |
| Commission approved | `CommissionCalculator::approveCommission` | Admins + Beneficiary | HTML body in service | `commission_approved_admin`, `commission_approved_beneficiary` |
| Payout batch created | `PayoutService::createBatch` | Admin | Inline HTML summary | `payout_batch_created` |
| Payout batch approved | `PayoutService::approveBatch` | Admin | Inline HTML summary | `payout_batch_approved` |
| Payout batch disbursed | `PayoutService::recordDisbursement` | Admin + Beneficiaries | Admin summary + beneficiary email | `payout_batch_disbursed` |
| Payout batch cancelled | `PayoutService::cancelBatch` | Admin | Cancellation summary | `payout_batch_cancelled` |
| Pending threshold alert | `CommissionService::getSummary` (via analytics) | Admin | Threshold warning | `pending_commission_threshold` |

## Configuration

Settings are stored in `mlm_settings`. Use the helper `MlmSettings::set($key, $value)`.

| Key | Purpose | Default |
| --- | --- | --- |
| `pending_commission_threshold` | Amount (â‚¹) that triggers admin warning when pending commissions exceed it | `0` (disabled) |

Example (tinker script or controller):
```php
MlmSettings::set('pending_commission_threshold', 250000);
```

Email sender information is sourced from `includes/config.php` (`$config['email']`). Ensure `mail()` is configured on the host.

## Operations Checklist

1. **Daily Review**
   - Check `mlm_notification_log` for `status = 'failed'` entries.
   - Verify cron jobs (daily digest) succeeded once implemented.

2. **Troubleshooting**
   - For failed emails, inspect `error_message` column.
   - Confirm server mail configuration (`sendmail`/SMTP) works.
   - If MySQL logging fails, ensure schema updates are applied and `mlm_notification_log` exists.

3. **Disabling Notifications**
   - Set `pending_commission_threshold` to `0` to silence threshold alerts.
   - Temporary disable can be done by commenting notification calls and deploying a hotfix (not recommended long term).

4. **Audit and Compliance**
   - Export log using `SELECT * FROM mlm_notification_log WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)`.
   - Data contains channel, type, payload JSON, and status for external audit.

## Future Enhancements

- Move HTML snippets into dedicated templates (`resources/templates/mail/*.php`).
- Implement WhatsApp/SMS adapters reusing `NotificationService`.
- Add daily digest cron (`tools/mlm_digest.php`) summarizing:
  - Pending commissions count/total
  - Batches awaiting approval
  - Top beneficiaries yesterday

## Contact

For issues or feature requests, update this document and coordinate with the DevOps contact listed in `docs/operations/README.md`.
